version: '3'

services:
    database:
        image: postgres:14.1-alpine
        container_name: pg_sql
        ports:
            - 5432:5432
        environment:
            POSTGRES_PASSWORD: password
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            timeout: 20s
            retries: 10
    model-migrate:
        container_name: model-backend-migrate
        build:
            context: .
            dockerfile: ./Dockerfile
        depends_on:
            database:
                condition: service_healthy    
        restart: on-failure
        env_file: .env
        environment:
            CFG_DATABASE_HOST: database        
        entrypoint: ./migrate

    model-backend:
        container_name: model-backend
        build:
            context: .
            dockerfile: ./Dockerfile
        depends_on:
            triton-server:
                condition: service_healthy    
        env_file: .env
        environment:
            CFG_DATABASE_HOST: database
        restart: on-failure
        ports:
            - 8080:8080
        volumes:
            - models:/models

    triton-server:
        # image: europe-west2-docker.pkg.dev/prj-c-devops-artifacts-a306/triton/triton-server:1.4.0
        image: nvcr.io/nvidia/tritonserver:21.09-py3
        command: tritonserver --model-store=/models --model-control-mode=explicit --allow-http=true --strict-model-config=false --log-verbose=1
        volumes:
            - models:/models
            - ./conda-pack:/conda-pack
        ports:
            - 8001:8001
        healthcheck:
            test: ["CMD-SHELL", "curl localhost:8000/v2/health/ready"]
            timeout: 20s
            retries: 10            
    # modelmesh:
    #     image: model-mesh:v0.7.0 
volumes:
    dbdata:
    models:
