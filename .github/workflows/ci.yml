name: ci

on:
  pull_request:
    branches:
      - main

env:
  DOCKER_HUB_REPOSITORY: instill/model

jobs:
  get-version:
    runs-on: [self-hosted, on-prem, dgx]
    # Skip if the event is triggered by the PR of release-please action (for pushing back to main branch for updating changelog and bumping up version)
    if: ${{ !contains(github.head_ref, 'release') }}
    outputs:
      CORE_VERSION: ${{ steps.get-version.outputs.CORE_VERSION }}
      GITHUB_SHA: ${{ steps.get-version.outputs.GITHUB_SHA }}
    steps:
      - name: Checkout (latest)
        uses: actions/checkout@v2

      - name: Get version
        id: get-version
        shell: bash
        run: |
          CORE_VERSION=$(cat version.txt)
          GITHUB_SHA=$(echo ${{ github.event.pull_request.head.sha }} | cut -c -7)
          echo "::set-output name=CORE_VERSION::$CORE_VERSION"
          echo "::set-output name=GITHUB_SHA::$GITHUB_SHA"

  build:
    runs-on: [self-hosted, on-prem, dgx]
    needs: [get-version]
    steps:
      - name: Checkout (latest)
        uses: actions/checkout@v2

      - name: Build build-metadata image
        run: |
          DOCKER_BUILDKIT=1 docker build -t $DOCKER_HUB_REPOSITORY:${{ needs.get-version.outputs.CORE_VERSION }}_${{ needs.get-version.outputs.GITHUB_SHA }} .

  push:
    runs-on: [self-hosted, on-prem, dgx]
    needs: [get-version, build]
    steps:
      - name: Push build-metadata image
        env: 
          DOCKER_HUB_PWD: ${{ secrets.botDockerHubPassword }}
        run: |
          echo $DOCKER_HUB_PWD | docker login -u dropletbot --password-stdin
          docker push $DOCKER_HUB_REPOSITORY:${{ needs.get-version.outputs.CORE_VERSION }}_${{ needs.get-version.outputs.GITHUB_SHA }}
