syntax = "proto3";

package instill.model.v1alpha;

// Protobuf standard
import "google/protobuf/struct.proto";

// Google api
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";

import "definition.proto";

// LivenessRequest represents a request to check a service liveness status
message LivenessRequest {
  // Service name to check for its liveness status
  string service = 1 [ (google.api.field_behavior) = OPTIONAL ];
}

// LivenessResponse represents a response for a service liveness status
message LivenessResponse {
  // ServingStatus enumerates the status of a queried service
  enum ServingStatus {
    // Serving status: UNSPECIFIED
    SERVING_STATUS_UNSPECIFIED = 0;
    // Serving status: SERVING
    SERVING_STATUS_SERVING = 1;
    // Serving status: NOT SERVING
    SERVING_STATUS_NOT_SERVING = 2;
  }

  // Status is the instance of the enum type ServingStatus
  ServingStatus status = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// ReadinessRequest represents a request to check a service readiness status
message ReadinessRequest {
  // Service name to check for its readiness status
  string service = 1 [ (google.api.field_behavior) = OPTIONAL ];
}

// ReadinessResponse represents a response for a service readiness status
message ReadinessResponse {
  // ServingStatus enumerates the status of a queried service
  enum ServingStatus {
    // Serving status: UNSPECIFIED
    SERVING_STATUS_UNSPECIFIED = 0;
    // Serving status: SERVING
    SERVING_STATUS_SERVING = 1;
    // Serving status: NOT SERVING
    SERVING_STATUS_NOT_SERVING = 2;
  }

  // Status is the value of ServingStatus enum type
  ServingStatus status = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// CreateModelBinaryFileUploadRequest represents a request to create a model
message CreateModelBinaryFileUploadRequest {
  // Model name
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Model content in bytes
  bytes bytes = 2 [ (google.api.field_behavior) = REQUIRED ];
  // Model description
  string description = 3 [ (google.api.field_behavior) = OPTIONAL ];
  // Model visibility
  // If does not specify visibility, then default will be VISIBILITY_PRIVATE
  ModelDefinition.Visibility visibility = 4 [ (google.api.field_behavior) = OPTIONAL ];
}

// CreateModelBinaryFileUploadResponse represents a response for a model
// instance
message CreateModelBinaryFileUploadResponse {
  // A model instance
  ModelDefinition model = 1  [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// CreateModelByGitHubRequest represents a request to create a model from a GitHub repo
message CreateModelByGitHubRequest {
  // Model name
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Model GitHub source
  Configuration github = 2 [ (google.api.field_behavior) = REQUIRED ];
  // Model mode including public or private
  // If does not specify visibility, then default will be the same as the visibility of GitHub repository
  ModelDefinition.Visibility visibility = 3 [ (google.api.field_behavior) = OPTIONAL ];
}

// CreateModelByGitHubResponse represents a response for a model
// instance
message CreateModelByGitHubResponse {
  // A model instance
  ModelDefinition model = 1  [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// UpdateModelInstanceRequest represents a request to update a model instance
message UpdateModelInstanceRequest {
  // Model name
  string model_name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Model instance name
  string instance_name = 2 [ (google.api.field_behavior) = REQUIRED ];
  // Model instance status
  ModelInstance.Status status = 3 [ (google.api.field_behavior) = REQUIRED ];
}

// UpdateModelInstanceResponse represents a response for a model instance
message UpdateModelInstanceResponse {
  // A model instance
  ModelInstance instance = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// ListModelRequest represents a request to list models
message ListModelRequest {}

// ListModelResponse represents a response for a list of models
message ListModelResponse {
  // A list of models
  repeated ModelDefinition models = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// GetModelRequest represents a request to query a model
message GetModelRequest {
  // Model name
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
}

// GetModelResponse represents a response for a model instance
message GetModelResponse {
  // A model instance
  ModelDefinition model = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// DeleteModelRequest represents a request to delete a model
message DeleteModelRequest {
  // Model name
  string name = 1 [ (google.api.field_behavior) = REQUIRED ];
}

// DeleteModelResponse represents an empty response
message DeleteModelResponse {}

// DeleteModelInstanceRequest represents a request to delete a model instance
message DeleteModelInstanceRequest {
  // Model name
  string model_name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Model instance name
  string instance_name = 2 [ (google.api.field_behavior) = REQUIRED ];
}

// DeleteModelInstanceResponse represents an empty response
message DeleteModelInstanceResponse {}

// Input represents the input to a model
message Input {
  // Input type
  oneof type {
    // Image type URL
    string image_url = 1;
    // Image type base64
    string image_base64 = 2;
  }
}

// TriggerModelRequest represents a request to trigger a model
message TriggerModelRequest {
  // Model name
  string model_name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Model instance name, default will be 'latest'
  string instance_name = 2 [ (google.api.field_behavior) = OPTIONAL ];
  // Input to the model
  repeated Input inputs = 3 [ (google.api.field_behavior) = REQUIRED ];
}

// TriggerModelResponse represents a response for the output of a model
message TriggerModelResponse {
  // Output from a model
  google.protobuf.Struct output = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// TriggerModelBinaryFileUploadRequest represents a request to trigger a model
message TriggerModelBinaryFileUploadRequest {
  // Model name
  string model_name = 1 [ (google.api.field_behavior) = REQUIRED ];
  // Model instance name
  string instance_name = 2 [ (google.api.field_behavior) = OPTIONAL ];
  // list of image's file length
  repeated uint64 file_lengths = 3 [ (google.api.field_behavior) = REQUIRED ];
  // Content of images in bytes
  bytes bytes = 4 [ (google.api.field_behavior) = REQUIRED ];
}

// TriggerModelBinaryFileUploadResponse represents a response for the output of
// a model
message TriggerModelBinaryFileUploadResponse {
  // Output from a model
  google.protobuf.Struct output = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// ClassificationOutput represents the output of classification task
message ClassificationOutput {
  // Classification category
  string category = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Classification score
  float score = 2 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// ClassificationOutputs represents a list of classification task outputs
message ClassificationOutputs {
  // A list of classification outputs
  repeated ClassificationOutput classification_outputs = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// BoundingBox represents the bounding box data structure
message BoundingBox {
  // Bounding box top y-axis value
  float top = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Bounding box left x-axis value
  float left = 2 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Bounding box width value
  float width = 3 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Bounding box height value
  float height = 4 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// BoundingBoxObject represents a predicted bounding box object
message BoundingBoxObject {
  // Bounding box object category
  string category = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Bounding box object score
  float score = 2 [ (google.api.field_behavior) = OUTPUT_ONLY ];
  // Bounding box
  BoundingBox bounding_box = 3 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// DetectionOutput represents the output of detection task
message DetectionOutput {
  // A list of bounding box objects
  repeated BoundingBoxObject bounding_box_objects = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// DetectionOutputs represents a list of detection task outputs
message DetectionOutputs {
  // A list of detection outputs
  repeated DetectionOutput detection_outputs = 1 [ (google.api.field_behavior) = OUTPUT_ONLY ];
}

// Model service responds to incoming model requests.
service ModelService {

  // Liveness method receives a LivenessRequest message and returns a
  // LivenessResponse message.
  // See https://github.com/grpc/grpc/blob/master/doc/health-checking.md
  rpc Liveness(LivenessRequest) returns (LivenessResponse) {
    option (google.api.http) = {
      get : "/__liveness"
      additional_bindings : [ {get : "/health/model"} ]
    };
  }

  // Readiness method receives a ReadinessRequest message and returns a
  // ReadinessResponse message.
  // See https://github.com/grpc/grpc/blob/master/doc/health-checking.md
  rpc Readiness(ReadinessRequest) returns (ReadinessResponse) {
    option (google.api.http) = {
      get : "/__readiness"
    };
  }

  // CreateModelByGitHub method receives a
  // CreateModelByGitHubRequest message and returns a
  // CreateModelByGitHubResponse message.
  rpc CreateModelByGitHub(CreateModelByGitHubRequest)
      returns (CreateModelByGitHubResponse) {
        option (google.api.http) = {
          post : "/models"
          body : "*"
        };
      }

  // CreateModelBinaryFileUpload method receives a
  // CreateModelBinaryFileUploadRequest message and returns a
  // CreateModelBinaryFileUploadResponse message.
  rpc CreateModelBinaryFileUpload(stream CreateModelBinaryFileUploadRequest)
      returns (CreateModelBinaryFileUploadResponse) {}

  // CreateModel method receives a CreateModelRequest message and returns
  // a CreateModelResponse message.
  rpc ListModel(ListModelRequest) returns (ListModelResponse) {
    option (google.api.http) = {
      get : "/models"
    };
  }

  // GetModel method receives a GetModelRequest message and returns
  // a GetModelResponse message.
  rpc GetModel(GetModelRequest) returns (GetModelResponse) {
    option (google.api.http) = {
      get : "/models/{name}"
    };
  }

  // UpdateModelInstance method receives a UpdateModelInstanceRequest message and
  // returns a UpdateModelInstanceResponse message.
  rpc UpdateModelInstance(UpdateModelInstanceRequest)
      returns (UpdateModelInstanceResponse) {
    option (google.api.http) = {
      patch : "/models/{model_name}/instances/{instance_name}"
      body : "*"
    };
  }

  // DeleteModel method receives a DeleteModelRequest message and returns
  // a DeleteModelResponse message.
  rpc DeleteModel(DeleteModelRequest) returns (DeleteModelResponse) {
    option (google.api.http) = {
      delete : "/models/{name}"
    };
  }

  // DeleteModelInstance method receives a DeleteModelInstanceRequest message and
  // returns a DeleteModelInstanceResponse message.
  rpc DeleteModelInstance(DeleteModelInstanceRequest)
      returns (DeleteModelInstanceResponse) {
    option (google.api.http) = {
      delete : "/models/{model_name}/instances/{instance_name}"
    };
  }

  // TriggerModel method receives a TriggerModelRequest message and
  // returns a TriggerModelResponse message.
  rpc TriggerModel(TriggerModelRequest) returns (TriggerModelResponse) {
    option (google.api.http) = {
      post : "/models/{model_name}/instances/{instance_name}/outputs"
      body : "*"
    };
  }

  // TriggerModelBinaryFileUpload method receives a
  // TriggerModelBinaryFileUploadRequest message and returns a
  // TriggerModelBinaryFileUploadResponse message.
  rpc TriggerModelBinaryFileUpload(stream TriggerModelBinaryFileUploadRequest)
      returns (TriggerModelBinaryFileUploadResponse) {}
}